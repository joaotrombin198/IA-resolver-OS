{% extends "base.html" %}

{% block title %}Diagnosticar Problema - Assistente OS{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="text-center mb-4">
            <h1 class="text-white mb-3">
                <i data-feather="search" class="me-2"></i>
                Diagnóstico Inteligente
            </h1>
            <p class="text-secondary mb-0">Descreva seu problema técnico e obtenha soluções inteligentes baseadas em casos similares</p>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Problem Input Section -->
        <div class="card mb-4">
            <div class="card-body">
                <form action="{{ url_for('analyze_problem') }}" method="POST">
                    <div class="mb-3">
                        <label for="problem_description" class="form-label">
                            Descrição do Problema <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" 
                                id="problem_description" 
                                name="problem_description" 
                                rows="6" 
                                placeholder="Descreva o problema técnico que você está enfrentando. Inclua sistema, erro e detalhes..."
                                onkeydown="handleEnterSubmit(event)"
                                required>{{ problem_description or '' }}</textarea>

                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i data-feather="search" class="me-2"></i>
                            Analisar Problema
                        </button>
                    </div>
                </form>
            </div>
        </div>

        {% if suggestion %}
        <!-- ML Analysis Results -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i data-feather="cpu" class="me-2"></i>
                    <h5 class="mb-0">Análise por Machine Learning</h5>
                </div>
                <div>
                    <span class="badge bg-{{ 'success' if suggestion.confidence > 0.7 else 'warning' if suggestion.confidence > 0.4 else 'secondary' }}">
                        {{ "%.0f"|format(suggestion.confidence * 100) }}% Confidence
                    </span>
                    <span class="badge bg-info ms-1">{{ suggestion.system_type }}</span>
                </div>
            </div>
            <div class="card-body">
                <h6 class="text-muted mb-3">Soluções Sugeridas:</h6>
                <div class="row">
                    {% for solution in suggestion.suggested_solutions %}
                    <div class="col-12 mb-3">
                        <div class="card bg-dark border-secondary">
                            <div class="card-body">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="d-flex align-items-start flex-grow-1">
                                        <span class="badge bg-primary me-3 mt-1">{{ loop.index }}</span>
                                        <div class="flex-grow-1">
                                            <p class="mb-0">{{ solution }}</p>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-1 ms-3">
                                        <button class="btn btn-sm btn-outline-success" onclick="rateSuggestion({{ loop.index0 }}, 'helpful')" title="Útil">
                                            <i data-feather="thumbs-up" style="width: 14px; height: 14px;"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="rateSuggestion({{ loop.index0 }}, 'not_helpful')" title="Não útil">
                                            <i data-feather="thumbs-down" style="width: 14px; height: 14px;"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Feedback Section -->
                <!-- Solution Resolution Actions -->
                <div class="border-top pt-3 mt-3">
                    <div class="mb-3">
                        <h6 class="text-muted mb-0">Problema Resolvido?</h6>
                    </div>
                    
                    <!-- Quick Resolution Actions -->
                    <div class="row mb-3">
                        {% for solution in suggestion.suggested_solutions %}
                        <div class="col-12 mb-2">
                            <button class="btn btn-sm btn-outline-success w-100" onclick="convertToCase('{{ solution }}', {{ loop.index }})">
                                <i data-feather="check-circle" class="me-1"></i>
                                ✅ Funcionou! Salvar Solução {{ loop.index }} como Caso
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-muted mb-0">Avalie as Sugestões</h6>
                    </div>
                    

                    
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <button class="btn btn-sm btn-outline-success" onclick="openFeedbackModal(5)">
                            <i data-feather="thumbs-up" class="me-1"></i>
                            Muito Útil
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="openFeedbackModal(4)">
                            <i data-feather="check" class="me-1"></i>
                            Útil
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="openFeedbackModal(3)">
                            <i data-feather="minus" class="me-1"></i>
                            Razoável
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="openFeedbackModal(2)">
                            <i data-feather="x" class="me-1"></i>
                            Pouco Útil
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="openFeedbackModal(1)">
                            <i data-feather="thumbs-down" class="me-1"></i>
                            Não Útil
                        </button>
                    </div>
                </div>
            </div>
        </div>

        {% if suggestion.similar_cases %}
        <!-- Similar Cases Section -->
        <div class="card mb-4">
            <div class="card-header d-flex align-items-center">
                <i data-feather="layers" class="me-2"></i>
                <h5 class="mb-0">Casos Similares Encontrados</h5>
            </div>
            <div class="card-body">
                {% for case in suggestion.similar_cases %}
                <div class="card bg-dark border-secondary mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">Case #{{ case.id }}</h6>
                            <div>
                                <span class="badge system-badge" data-system="{{ case.system_type }}">{{ case.system_type }}</span>
                                {% if case.effectiveness_score %}
                                <span class="badge bg-success">{{ "%.1f"|format(case.effectiveness_score) }}/5</span>
                                {% endif %}
                            </div>
                        </div>
                        <p class="text-muted mb-2"><strong>Problema:</strong> {{ case.problem_description[:350] }}{% if case.problem_description|length > 350 %}...{% endif %}</p>
                        <p class="mb-0"><strong>Solução:</strong> {{ case.solution[:350] }}{% if case.solution|length > 350 %}...{% endif %}</p>
                        <div class="mt-2">
                            <a href="{{ url_for('view_case', case_id=case.id) }}" class="btn btn-sm btn-outline-primary">
                                <i data-feather="external-link" class="me-1"></i>
                                Ver Detalhes
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% endif %}

        <!-- Quick Actions -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i data-feather="plus-circle" class="mb-2" style="width: 48px; height: 48px;"></i>
                        <h6>Adicionar Novo Caso</h6>
                        <p class="text-muted small">Adicione casos resolvidos</p>
                        <a href="{{ url_for('add_case_form') }}" class="btn btn-outline-primary">Adicionar Caso</a>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i data-feather="bar-chart-2" class="mb-2" style="width: 48px; height: 48px;"></i>
                        <h6>Ver Painel</h6>
                        <p class="text-muted small">Ver todos os casos e estatísticas</p>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">Ver Painel</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Feedback Detalhado -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="feedbackModalLabel">
                    <i data-feather="star" class="me-2"></i>
                    Feedback Detalhado
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="feedbackForm">
                    <input type="hidden" id="feedbackScore" name="score">
                    
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Avaliação Geral: <span id="feedbackScoreText" class="text-primary"></span></h6>
                        <div class="rating-display mb-3">
                            <div id="starRating" class="d-flex gap-1">
                                <!-- Stars will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">O que funcionou bem? (Opcional)</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="goodRelevant" name="good[]" value="relevant">
                                    <label class="form-check-label" for="goodRelevant">
                                        Sugestões relevantes para o problema
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="goodClear" name="good[]" value="clear">
                                    <label class="form-check-label" for="goodClear">
                                        Instruções claras e detalhadas
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="goodSystem" name="good[]" value="system">
                                    <label class="form-check-label" for="goodSystem">
                                        Identificou o sistema corretamente
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="goodSimilar" name="good[]" value="similar">
                                    <label class="form-check-label" for="goodSimilar">
                                        Casos similares foram úteis
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="goodOrder" name="good[]" value="order">
                                    <label class="form-check-label" for="goodOrder">
                                        Ordem das sugestões faz sentido
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="goodComplete" name="good[]" value="complete">
                                    <label class="form-check-label" for="goodComplete">
                                        Sugestões completas e abrangentes
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">O que pode melhorar? (Opcional)</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="improveRelevant" name="improve[]" value="more_relevant">
                                    <label class="form-check-label" for="improveRelevant">
                                        Sugestões mais específicas para o problema
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="improveSystem" name="improve[]" value="system_detection">
                                    <label class="form-check-label" for="improveSystem">
                                        Melhor detecção do sistema
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="improveOrder" name="improve[]" value="better_order">
                                    <label class="form-check-label" for="improveOrder">
                                        Melhor priorização das sugestões
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="improveSimilar" name="improve[]" value="similar_cases">
                                    <label class="form-check-label" for="improveSimilar">
                                        Casos similares mais relevantes
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="improveDetail" name="improve[]" value="more_detail">
                                    <label class="form-check-label" for="improveDetail">
                                        Instruções mais detalhadas
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="improveMore" name="improve[]" value="more_suggestions">
                                    <label class="form-check-label" for="improveMore">
                                        Mais opções de solução
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="feedbackComments" class="form-label">
                            <h6 class="text-muted mb-0">Comentários Adicionais (Opcional)</h6>
                        </label>
                        <textarea class="form-control" id="feedbackComments" name="comments" rows="3" 
                                placeholder="Compartilhe sua experiência, sugestões específicas, ou conte se a solução funcionou..."></textarea>
                        <div class="form-text">
                            <i data-feather="info" class="me-1"></i>
                            Seus comentários são valiosos para melhorar o sistema.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitDetailedFeedback()">
                    <i data-feather="send" class="me-1"></i>
                    Enviar Feedback
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentProblemDescription = {{ (problem_description or "") | tojson }};
let suggestionRatings = {};

// Apply system colors to badges
document.addEventListener('DOMContentLoaded', function() {
    const systemColors = {
        'Sistema SGU': 'bg-primary',
        'SGU': 'bg-primary',
        'SGU-CRM': 'bg-info', 
        'SGU-Card': 'bg-success',
        'SGU Card': 'bg-success',
        'SGU-Portais': 'bg-warning',
        'SGU GPL': 'bg-secondary',
        'Autorizador/AutSC': 'bg-danger',
        'Autorizador': 'bg-danger',
        'Aplicativo Unimed Criciúma': 'bg-dark',
        'Tasy': 'bg-purple',
        'Syngoo': 'bg-cyan',
        'Pep RS': 'bg-orange',
        'Database': 'bg-pink',
        'Network': 'bg-info'
    };
    
    document.querySelectorAll('.system-badge').forEach(badge => {
        const system = badge.getAttribute('data-system');
        const colorClass = systemColors[system] || 'bg-secondary';
        badge.className = 'badge system-badge ' + colorClass;
    });
});

function rateSuggestion(suggestionIndex, rating) {
    suggestionRatings[suggestionIndex] = rating;
    
    // Visual feedback
    const buttons = document.querySelectorAll(`button[onclick*="rateSuggestion(${suggestionIndex}"]`);
    buttons.forEach(btn => {
        btn.classList.remove('btn-success', 'btn-danger');
        btn.classList.add('btn-outline-success', 'btn-outline-danger');
    });
    
    // Highlight selected button
    const targetBtn = document.querySelector(`button[onclick*="rateSuggestion(${suggestionIndex}, '${rating}'"]`);
    if (targetBtn) {
        if (rating === 'helpful') {
            targetBtn.classList.remove('btn-outline-success');
            targetBtn.classList.add('btn-success');
        } else {
            targetBtn.classList.remove('btn-outline-danger');
            targetBtn.classList.add('btn-danger');
        }
    }
    
    // Log individual rating
    console.log(`Sugestão ${suggestionIndex + 1} avaliada como: ${rating}`);
    
    // Show brief feedback
    showToast(rating === 'helpful' ? 'Sugestão marcada como útil!' : 'Sugestão marcada como não útil!', 
              rating === 'helpful' ? 'success' : 'warning');
}

function convertToCase(solution, solutionIndex) {
    if (confirm(`Essa solução funcionou para você?\n\n"${solution}"\n\nVamos salvar isso como um caso para ajudar outros usuários!`)) {
        // Create form to submit the conversion
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/convert-to-case';
        
        // Add hidden fields
        const problemField = document.createElement('input');
        problemField.type = 'hidden';
        problemField.name = 'problem_description';
        problemField.value = currentProblemDescription;
        form.appendChild(problemField);
        
        const solutionField = document.createElement('input');
        solutionField.type = 'hidden';
        solutionField.name = 'solution';
        solutionField.value = solution;
        form.appendChild(solutionField);
        
        const systemField = document.createElement('input');
        systemField.type = 'hidden';
        systemField.name = 'system_type';
        systemField.value = '{{ suggestion.system_type if suggestion else "Unknown" }}';
        form.appendChild(systemField);
        
        document.body.appendChild(form);
        form.submit();
    }
}

function openFeedbackModal(score) {
    // Set the score
    document.getElementById('feedbackScore').value = score;
    
    // Update score display
    const scoreTexts = {
        5: 'Muito Útil ⭐⭐⭐⭐⭐',
        4: 'Útil ⭐⭐⭐⭐',
        3: 'Razoável ⭐⭐⭐',
        2: 'Pouco Útil ⭐⭐',
        1: 'Não Útil ⭐'
    };
    document.getElementById('feedbackScoreText').textContent = scoreTexts[score];
    
    // Create star rating display
    const starRating = document.getElementById('starRating');
    starRating.innerHTML = '';
    for (let i = 1; i <= 5; i++) {
        const star = document.createElement('i');
        star.setAttribute('data-feather', i <= score ? 'star' : 'star');
        star.className = i <= score ? 'text-warning' : 'text-muted';
        star.style.width = '20px';
        star.style.height = '20px';
        starRating.appendChild(star);
    }
    
    // Refresh feather icons
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
    modal.show();
}

function submitDetailedFeedback() {
    const form = document.getElementById('feedbackForm');
    const formData = new FormData(form);
    
    // Add problem description for context
    formData.append('problem_description', currentProblemDescription);
    
    // Add individual suggestion ratings
    formData.append('suggestion_ratings', JSON.stringify(suggestionRatings));
    
    // Collect checkboxes
    const goodAspects = [];
    const improvements = [];
    
    document.querySelectorAll('input[name="good[]"]:checked').forEach(checkbox => {
        goodAspects.push(checkbox.value);
    });
    
    document.querySelectorAll('input[name="improve[]"]:checked').forEach(checkbox => {
        improvements.push(checkbox.value);
    });
    
    formData.append('good_aspects', JSON.stringify(goodAspects));
    formData.append('improvements', JSON.stringify(improvements));
    
    // Submit feedback
    console.log('Enviando feedback...');
    fetch('/feedback', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackModal'));
            modal.hide();
            
            // Show success message
            showToast('Obrigado pelo seu feedback! Suas sugestões nos ajudam a melhorar o sistema.', 'success');
            
            // Reset form
            form.reset();
            
            // Clear suggestion ratings
            suggestionRatings = {};
        } else {
            showToast(data.message || 'Erro ao enviar feedback. Tente novamente.', 'danger');
        }
    })
    .catch(error => {
        console.error('Error submitting feedback:', error);
        showToast(`Erro de comunicação: ${error.message}`, 'danger');
    });
}

function showToast(message, type) {
    const toastHtml = `
        <div class="toast align-items-center text-bg-${type} border-0" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 1050;">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', toastHtml);
    const toast = new bootstrap.Toast(document.querySelector('.toast:last-child'));
    toast.show();
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        toast.hide();
    }, 5000);
}
</script>
{% endblock %}
